<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CognitoFeed</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: #0f1117; color: #e0e0e0; }

        header { background: #1a1d2e; padding: 16px 40px; border-bottom: 1px solid #2a2d3e; display: flex; align-items: center; justify-content: space-between; }
        header h1 { font-size: 22px; color: #7c6af7; }
        header p { font-size: 12px; color: #666; margin-top: 3px; }
        .header-akcje { display: flex; gap: 8px; align-items: center; }

        .container { max-width: 1100px; margin: 25px auto; padding: 0 20px; display: grid; grid-template-columns: 260px 1fr; gap: 25px; }

        /* SIDEBAR */
        .sidebar h2 { font-size: 13px; color: #666; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px; }
        .dodaj-kanal { background: #1a1d2e; border-radius: 12px; padding: 14px; margin-bottom: 16px; border: 1px solid #2a2d3e; }
        .dodaj-kanal input { width: 100%; background: #0f1117; border: 1px solid #2a2d3e; color: #e0e0e0; padding: 7px 11px; border-radius: 8px; font-size: 13px; margin-bottom: 7px; outline: none; }
        .dodaj-kanal input:focus { border-color: #7c6af7; }
        .kanal-item { background: #1a1d2e; border-radius: 10px; padding: 11px 14px; margin-bottom: 7px; border: 1px solid #2a2d3e; display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: border-color 0.2s; }
        .kanal-item:hover { border-color: #7c6af7; }
        .kanal-item.aktywny { border-color: #7c6af7; background: #1e1a3a; }
        .kanal-item .nazwa { font-size: 13px; font-weight: 600; }
        .kanal-item .url { font-size: 11px; color: #555; margin-top: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 170px; }
        .kanal-usun { background: none; border: none; color: #555; cursor: pointer; font-size: 15px; padding: 2px 5px; border-radius: 4px; flex-shrink: 0; }
        .kanal-usun:hover { color: #cf6679; background: #3a1a1a; }

        /* ZAK≈ÅADKI */
        .tabs { display: flex; gap: 6px; margin-bottom: 18px; }
        .tab { padding: 7px 16px; border-radius: 8px; border: 1px solid #2a2d3e; background: #1a1d2e; color: #888; cursor: pointer; font-size: 13px; transition: all 0.2s; }
        .tab:hover { border-color: #7c6af7; color: #e0e0e0; }
        .tab.aktywna { background: #7c6af7; border-color: #7c6af7; color: white; }

        /* STATS */
        .stats { display: flex; gap: 10px; margin-bottom: 18px; }
        .stat { background: #1a1d2e; padding: 11px 16px; border-radius: 10px; flex: 1; text-align: center; }
        .stat .liczba { font-size: 22px; font-weight: bold; color: #7c6af7; }
        .stat .opis { font-size: 11px; color: #666; margin-top: 2px; }

        /* ARTYKU≈ÅY */
        .artykul { background: #1a1d2e; border-radius: 12px; padding: 18px; margin-bottom: 13px; border: 1px solid #2a2d3e; transition: border-color 0.2s; }
        .artykul:hover { border-color: #7c6af7; }
        .artykul-top { display: flex; justify-content: space-between; align-items: flex-start; gap: 10px; }
        .artykul-tytul { font-size: 15px; font-weight: 600; margin-bottom: 7px; flex: 1; }
        .artykul-tytul a { color: #e0e0e0; text-decoration: none; }
        .artykul-tytul a:hover { color: #7c6af7; }
        .artykul-meta { font-size: 12px; color: #555; margin-bottom: 10px; }
        .podsumowanie { background: #12141f; border-left: 3px solid #7c6af7; padding: 9px 14px; border-radius: 0 8px 8px 0; margin-bottom: 9px; font-size: 13px; line-height: 1.6; }
        .artykul-akcje { display: flex; gap: 8px; align-items: center; margin-top: 10px; }
        .sentyment { display: inline-block; font-size: 11px; padding: 3px 9px; border-radius: 20px; }
        .sentyment.neutralny { background: #2a2d3e; color: #888; }
        .sentyment.pozytywny { background: #1a3a2a; color: #4caf82; }
        .sentyment.negatywny { background: #3a1a1a; color: #cf6679; }
        .btn-ulubiony { background: none; border: none; cursor: pointer; font-size: 18px; padding: 4px; opacity: 0.4; transition: opacity 0.2s, transform 0.2s; flex-shrink: 0; }
        .btn-ulubiony:hover { opacity: 1; transform: scale(1.2); }
        .btn-ulubiony.aktywny { opacity: 1; }
        .btn-reader { background: #2a2d3e; border: none; color: #888; cursor: pointer; font-size: 11px; padding: 4px 10px; border-radius: 6px; }
        .btn-reader:hover { background: #7c6af7; color: white; }

        /* PRZYCISKI */
        .btn { padding: 7px 14px; border-radius: 8px; border: none; cursor: pointer; font-size: 13px; font-weight: 600; transition: opacity 0.2s; }
        .btn:hover { opacity: 0.85; }
        .btn-primary { background: #7c6af7; color: white; }
        .btn-success { background: #4caf82; color: white; }

        /* POWIADOMIENIE badge */
        .notif-btn { position: relative; }
        .notif-badge { position: absolute; top: -5px; right: -5px; background: #cf6679; color: white; font-size: 10px; width: 18px; height: 18px; border-radius: 50%; display: none; align-items: center; justify-content: center; font-weight: bold; }
        .notif-badge.show { display: flex; }

        /* TOGGLE AUTO */
        .auto-toggle { display: flex; align-items: center; gap: 7px; background: #1a1d2e; padding: 7px 13px; border-radius: 8px; border: 1px solid #2a2d3e; cursor: pointer; font-size: 13px; user-select: none; transition: border-color 0.2s; }
        .auto-toggle:hover { border-color: #7c6af7; }
        .auto-toggle.wlaczone { border-color: #4caf82; }
        .toggle-switch { width: 30px; height: 16px; background: #2a2d3e; border-radius: 8px; position: relative; transition: background 0.2s; flex-shrink: 0; }
        .toggle-switch::after { content: ''; position: absolute; width: 10px; height: 10px; background: #888; border-radius: 50%; top: 3px; left: 3px; transition: all 0.2s; }
        .wlaczone .toggle-switch { background: #4caf82; }
        .wlaczone .toggle-switch::after { background: white; left: 17px; }
        .auto-label { color: #888; }
        .wlaczone .auto-label { color: #4caf82; }

        /* MODALE */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 200; display: none; align-items: center; justify-content: center; }
        .modal-overlay.otwarte { display: flex; }
        .modal { background: #1a1d2e; border-radius: 16px; width: 700px; max-height: 80vh; overflow-y: auto; padding: 28px; border: 1px solid #2a2d3e; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 18px; }
        .modal-header h2 { font-size: 19px; color: #7c6af7; }
        .trend-card { background: #12141f; border-radius: 12px; padding: 16px; margin-bottom: 13px; border: 1px solid #2a2d3e; }
        .trend-nazwa { font-size: 15px; font-weight: 700; color: #7c6af7; margin-bottom: 5px; }
        .trend-opis { font-size: 13px; color: #888; margin-bottom: 10px; }
        .trend-art { font-size: 13px; padding: 5px 0; border-bottom: 1px solid #1a1d2e; }
        .trend-art a { color: #e0e0e0; text-decoration: none; }
        .trend-art a:hover { color: #7c6af7; }
        .trend-art:last-child { border-bottom: none; }
        .trend-liczba { display: inline-block; background: #2a2d3e; color: #7c6af7; font-size: 11px; padding: 2px 7px; border-radius: 10px; margin-left: 7px; }
        .reader-modal { background: #1a1d2e; border-radius: 16px; width: 750px; max-height: 85vh; overflow-y: auto; padding: 35px; border: 1px solid #2a2d3e; }
        .reader-tytul { font-size: 22px; font-weight: 700; margin-bottom: 20px; line-height: 1.4; }
        .reader-tresc { font-size: 15px; line-height: 1.8; color: #bbb; white-space: pre-wrap; }

        /* CZAT */
        .chat-btn { position: fixed; bottom: 28px; right: 28px; background: #7c6af7; color: white; border: none; border-radius: 50%; width: 50px; height: 50px; font-size: 20px; cursor: pointer; box-shadow: 0 4px 20px rgba(124,106,247,0.4); z-index: 100; transition: transform 0.2s; }
        .chat-btn:hover { transform: scale(1.1); }
        .chat-okno { position: fixed; bottom: 90px; right: 28px; width: 370px; background: #1a1d2e; border: 1px solid #2a2d3e; border-radius: 16px; display: none; flex-direction: column; z-index: 100; box-shadow: 0 8px 40px rgba(0,0,0,0.5); overflow: hidden; }
        .chat-okno.otwarte { display: flex; }
        .chat-header { padding: 13px 17px; background: #12141f; border-bottom: 1px solid #2a2d3e; font-weight: 600; font-size: 14px; display: flex; justify-content: space-between; }
        .chat-zamknij { background: none; border: none; color: #666; cursor: pointer; font-size: 17px; }
        .chat-wiadomosci { height: 300px; overflow-y: auto; padding: 13px; display: flex; flex-direction: column; gap: 9px; }
        .wiadomosc { max-width: 85%; padding: 9px 13px; border-radius: 12px; font-size: 13px; line-height: 1.5; }
        .wiadomosc.user { background: #7c6af7; color: white; align-self: flex-end; border-radius: 12px 12px 2px 12px; }
        .wiadomosc.ai { background: #12141f; color: #e0e0e0; align-self: flex-start; border-radius: 12px 12px 12px 2px; }
        .chat-input { display: flex; padding: 11px; gap: 7px; border-top: 1px solid #2a2d3e; }
        .chat-input input { flex: 1; background: #0f1117; border: 1px solid #2a2d3e; color: #e0e0e0; padding: 7px 11px; border-radius: 8px; font-size: 13px; outline: none; }
        .chat-input input:focus { border-color: #7c6af7; }
        .chat-input button { background: #7c6af7; color: white; border: none; padding: 7px 13px; border-radius: 8px; cursor: pointer; font-size: 15px; }

        /* TOAST */
        .toast { position: fixed; bottom: 28px; left: 50%; transform: translateX(-50%); background: #1a1d2e; border: 1px solid #7c6af7; padding: 11px 20px; border-radius: 10px; font-size: 14px; display: none; z-index: 999; white-space: nowrap; }
        .toast.show { display: block; }
    </style>
</head>
<body>
    <header>
        <div>
            <h1>üß† CognitoFeed</h1>
            <p>Inteligentny asystent wiedzy</p>
        </div>
        <div class="header-akcje">
            <div class="auto-toggle" id="auto-toggle" onclick="prze≈ÇƒÖczAuto()">
                <div class="toggle-switch"></div>
                <span class="auto-label">Auto</span>
            </div>
            <button class="btn btn-success" onclick="odswiez()">üîÑ Od≈õwie≈º</button>
            <button class="btn" style="background:#2a2d3e;color:#e0e0e0" onclick="pokazTrendy()">üìå Trendy</button>
            <div class="notif-btn">
                <button class="btn" style="background:#2a2d3e;color:#e0e0e0" onclick="pokazPowiadomienia()">üîî</button>
                <div class="notif-badge" id="notif-badge">0</div>
            </div>
        </div>
    </header>

    <div class="container">
        <div class="sidebar">
            <h2>Kana≈Çy RSS</h2>
            <div class="dodaj-kanal">
                <input type="text" id="input-url" placeholder="https://example.com/rss.xml" />
                <button class="btn btn-primary" style="width:100%" onclick="dodajKanal()">+ Dodaj kana≈Ç</button>
            </div>
            <div id="lista-kanalow"></div>
        </div>

        <div class="main">
            <div class="stats">
                <div class="stat"><div class="liczba" id="liczba-artykulow">-</div><div class="opis">artyku≈Ç√≥w</div></div>
                <div class="stat"><div class="liczba" id="liczba-kanalow">-</div><div class="opis">kana≈Ç√≥w</div></div>
                <div class="stat"><div class="liczba" id="nastepne-odswiez">-</div><div class="opis">min do od≈õw.</div></div>
            </div>
            <div class="tabs">
                <div class="tab aktywna" onclick="pokazTab('wszystkie', this)">üì∞ Wszystkie</div>
                <div class="tab" onclick="pokazTab('ulubione', this)">‚≠ê Ulubione</div>
            </div>
            <div id="lista-artykulow"></div>
        </div>
    </div>

    <!-- MODAL TRENDY -->
    <div class="modal-overlay" id="modal-trendy" onclick="if(event.target===this) zamknijModal('modal-trendy')">
        <div class="modal">
            <div class="modal-header">
                <h2>üìå Wykryte trendy</h2>
                <button class="chat-zamknij" onclick="zamknijModal('modal-trendy')">‚úï</button>
            </div>
            <div id="trendy-content"></div>
        </div>
    </div>

    <!-- READER VIEW -->
    <div class="modal-overlay" id="modal-reader" onclick="if(event.target===this) zamknijModal('modal-reader')">
        <div class="reader-modal">
            <div class="modal-header">
                <h2>üìñ Tryb czytania</h2>
                <button class="chat-zamknij" onclick="zamknijModal('modal-reader')">‚úï</button>
            </div>
            <div class="reader-tytul" id="reader-tytul"></div>
            <div class="reader-tresc" id="reader-tresc"></div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <!-- CZAT -->
    <button class="chat-btn" onclick="toggleChat()">üí¨</button>
    <div class="chat-okno" id="chat-okno">
        <div class="chat-header">
            üß† Zapytaj AI o artyku≈Çy
            <button class="chat-zamknij" onclick="toggleChat()">‚úï</button>
        </div>
        <div class="chat-wiadomosci" id="chat-wiadomosci">
            <div class="wiadomosc ai">Cze≈õƒá! Zapytaj mnie o cokolwiek zwiƒÖzanego z artyku≈Çami. üòä</div>
        </div>
        <div class="chat-input">
            <input type="text" id="chat-input" placeholder="Zadaj pytanie..." onkeydown="if(event.key==='Enter') wyslijChat()" />
            <button onclick="wyslijChat()">‚û§</button>
        </div>
    </div>

    <script>
        let autoAktywne = false;
        let aktywnyKanal = null;
        let aktywnaZakladka = 'wszystkie';
        let minutnik = null;
        let minutyDoOdswiezenia = 30;

        function pokazToast(msg, kolor = '#7c6af7') {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.style.borderColor = kolor;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        }

        function getSentymentKlasa(s) {
            if (!s) return 'neutralny';
            const sl = s.toLowerCase();
            if (sl.includes('pozytywny')) return 'pozytywny';
            if (sl.includes('negatywny')) return 'negatywny';
            return 'neutralny';
        }

        function renderujArtykuly(artykuly) {
            document.getElementById('liczba-artykulow').textContent = artykuly.length;
            const lista = document.getElementById('lista-artykulow');
            if (!artykuly.length) {
                lista.innerHTML = '<div style="text-align:center;padding:60px;color:#555">Brak artyku≈Ç√≥w</div>';
                return;
            }
            lista.innerHTML = artykuly.map(art => `
                <div class="artykul" id="art-${art.id}">
                    <div class="artykul-top">
                        <div class="artykul-tytul"><a href="${art.link}" target="_blank">${art.tytul}</a></div>
                        <button class="btn-ulubiony ${art.ulubiony ? 'aktywny' : ''}" onclick="toggleUlubiony(${art.id}, this)">
                            ${art.ulubiony ? '‚≠ê' : '‚òÜ'}
                        </button>
                    </div>
                    <div class="artykul-meta">${art.kanal_url} ¬∑ ${art.data_publikacji || ''}</div>
                    ${art.podsumowanie_krotkie ? `<div class="podsumowanie">üí¨ ${art.podsumowanie_krotkie}</div>` : ''}
                    <div class="artykul-akcje">
                        ${art.sentyment ? `<span class="sentyment ${getSentymentKlasa(art.sentyment)}">${art.sentyment.split('.')[0]}</span>` : ''}
                        <button class="btn-reader" onclick="pokazReader('${encodeURIComponent(art.link)}')">üìñ Czytaj</button>
                    </div>
                </div>
            `).join('');
        }

        async function ladujArtykuly() {
            if (aktywnaZakladka === 'ulubione') {
                const res = await fetch('/api/ulubione');
                renderujArtykuly(await res.json());
                return;
            }
            const url = aktywnyKanal
                ? `/api/artykuly/kanal?url=${encodeURIComponent(aktywnyKanal)}&limit=50`
                : '/api/artykuly?limit=50';
            const res = await fetch(url);
            renderujArtykuly(await res.json());
        }

        async function ladujKanaly() {
            const res = await fetch('/api/kanaly');
            const kanaly = await res.json();
            document.getElementById('liczba-kanalow').textContent = kanaly.length;
            document.getElementById('lista-kanalow').innerHTML = kanaly.map(k => `
                <div class="kanal-item ${aktywnyKanal === k.url ? 'aktywny' : ''}" onclick="filtrujKanal('${k.url}')">
                    <div>
                        <div class="nazwa">${k.tytul}</div>
                        <div class="url">${k.url}</div>
                    </div>
                    <button class="kanal-usun" onclick="event.stopPropagation(); usunKanal(${k.id})" title="Usu≈Ñ">‚úï</button>
                </div>
            `).join('');
        }

        function pokazTab(nazwa, el) {
            aktywnaZakladka = nazwa;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('aktywna'));
            el.classList.add('aktywna');
            ladujArtykuly();
        }

        function filtrujKanal(url) {
            aktywnyKanal = aktywnyKanal === url ? null : url;
            ladujKanaly();
            ladujArtykuly();
        }

        async function toggleUlubiony(id, btn) {
            const res = await fetch(`/api/artykuly/${id}/ulubiony`, { method: 'POST' });
            const dane = await res.json();
            btn.textContent = dane.ulubiony ? '‚≠ê' : '‚òÜ';
            btn.classList.toggle('aktywny', dane.ulubiony);
            if (aktywnaZakladka === 'ulubione') ladujArtykuly();
        }

        async function pokazReader(encodedUrl) {
            document.getElementById('reader-tytul').textContent = '≈Åadowanie...';
            document.getElementById('reader-tresc').textContent = '';
            document.getElementById('modal-reader').classList.add('otwarte');
            const res = await fetch(`/api/reader?url=${encodedUrl}`);
            const dane = await res.json();
            document.getElementById('reader-tytul').textContent = dane.tytul || 'Artyku≈Ç';
            document.getElementById('reader-tresc').textContent = dane.tresc;
        }

        async function dodajKanal() {
            const url = document.getElementById('input-url').value.trim();
            if (!url) return;
            pokazToast('‚è≥ Dodajƒô kana≈Ç...');
            const res = await fetch('/api/kanaly/dodaj', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ url })
            });
            const dane = await res.json();
            pokazToast(dane.sukces ? '‚úÖ ' + dane.komunikat : '‚ùå ' + dane.komunikat, dane.sukces ? '#4caf82' : '#cf6679');
            if (dane.sukces) {
                document.getElementById('input-url').value = '';
                ladujArtykuly();
                ladujKanaly();
            }
        }

        async function usunKanal(id) {
            await fetch(`/api/kanaly/${id}`, { method: 'DELETE' });
            if (aktywnyKanal) aktywnyKanal = null;
            pokazToast('üóëÔ∏è Kana≈Ç usuniƒôty');
            ladujArtykuly();
            ladujKanaly();
        }

        async function odswiez() {
            pokazToast('‚è≥ Od≈õwie≈ºam...');
            const res = await fetch('/api/odswierz', { method: 'POST' });
            const dane = await res.json();
            if (dane.nowe_artykuly > 0) pokazPowiadomienieBadge(dane.nowe_artykuly);
            pokazToast(`‚úÖ Nowych artyku≈Ç√≥w: ${dane.nowe_artykuly}`, '#4caf82');
            minutyDoOdswiezenia = 30;
            document.getElementById('nastepne-odswiez').textContent = minutyDoOdswiezenia;
            ladujArtykuly();
        }

        function pokazPowiadomienieBadge(liczba) {
            const badge = document.getElementById('notif-badge');
            badge.textContent = liczba;
            badge.classList.add('show');
        }

        function pokazPowiadomienia() {
            document.getElementById('notif-badge').classList.remove('show');
            fetch('/api/powiadomienia/reset', { method: 'POST' });
            pokazToast('üîî Sprawd≈∫ nowe artyku≈Çy na li≈õcie', '#4caf82');
            ladujArtykuly();
        }

        async function pokazTrendy() {
            document.getElementById('modal-trendy').classList.add('otwarte');
            document.getElementById('trendy-content').innerHTML = '<div style="text-align:center;padding:40px;color:#555">‚è≥ Analizujƒô artyku≈Çy...</div>';
            const res = await fetch('/api/trendy');
            const trendy = await res.json();
            if (!trendy.length) {
                document.getElementById('trendy-content').innerHTML = '<div style="text-align:center;padding:40px;color:#555">Za ma≈Ço artyku≈Ç√≥w</div>';
                return;
            }
            document.getElementById('trendy-content').innerHTML = trendy.map(t => `
                <div class="trend-card">
                    <div class="trend-nazwa">${t.nazwa} <span class="trend-liczba">${t.liczba} art.</span></div>
                    <div class="trend-opis">${t.opis}</div>
                    ${t.artykuly.map(a => `<div class="trend-art"><a href="${a.link}" target="_blank">üì∞ ${a.tytul}</a></div>`).join('')}
                </div>
            `).join('');
        }

        function zamknijModal(id) {
            document.getElementById(id).classList.remove('otwarte');
        }

        function prze≈ÇƒÖczAuto() {
            autoAktywne = !autoAktywne;
            document.getElementById('auto-toggle').classList.toggle('wlaczone', autoAktywne);
            if (autoAktywne) {
                pokazToast('‚úÖ Auto-od≈õwie≈ºanie w≈ÇƒÖczone', '#4caf82');
                minutyDoOdswiezenia = 30;
                document.getElementById('nastepne-odswiez').textContent = minutyDoOdswiezenia;
                minutnik = setInterval(async () => {
                    minutyDoOdswiezenia--;
                    document.getElementById('nastepne-odswiez').textContent = minutyDoOdswiezenia;
                    if (minutyDoOdswiezenia <= 0) { minutyDoOdswiezenia = 30; await odswiez(); }
                }, 60000);
            } else {
                pokazToast('‚è∏Ô∏è Auto-od≈õwie≈ºanie wy≈ÇƒÖczone');
                clearInterval(minutnik);
                document.getElementById('nastepne-odswiez').textContent = '-';
            }
        }

        function toggleChat() {
            document.getElementById('chat-okno').classList.toggle('otwarte');
        }

        async function wyslijChat() {
            const input = document.getElementById('chat-input');
            const pytanie = input.value.trim();
            if (!pytanie) return;
            const wiadomosci = document.getElementById('chat-wiadomosci');
            wiadomosci.innerHTML += `<div class="wiadomosc user">${pytanie}</div>`;
            wiadomosci.innerHTML += `<div class="wiadomosc ai" id="czekam">‚è≥ My≈õlƒô...</div>`;
            wiadomosci.scrollTop = wiadomosci.scrollHeight;
            input.value = '';
            const res = await fetch('/api/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ pytanie })
            });
            const dane = await res.json();
            document.getElementById('czekam').remove();
            wiadomosci.innerHTML += `<div class="wiadomosc ai">${dane.odpowiedz}</div>`;
            wiadomosci.scrollTop = wiadomosci.scrollHeight;
        }

        ladujArtykuly();
        ladujKanaly();
    </script>
</body>
</html>